define(["zepto","underscore","backbone","echo","app/utils","app/basket","countdown","fly","text!templates/mall.html"],function(f,z,d,x,y,c,o,p,i){var j=f("#mall-page");var g;var l;var e;var b;var v;var h;var u=[];var q=null;var a=a;var t=d.View.extend({el:f("#mall-page"),render:function(B,C,A){a=A;y.showPage(j,function(){if(y.isEmpty(j)){j.empty().append(i);g=j.find(".he-marind-list");l=j.find("#tpl-goods-category");e=j.find("#tpl-goods-items");b=j.find("#tpl-goods-flash-sale");v=j.find("#tpl-goods-specials");h=j.find("#tpl-goods-hot");k()}});j.on("touchstart",".btn-increase",function(D){m(D)})},events:{"tap .btn-decrease":"removeToBasket","tap .goods-item":"redirectGoodsDetail","tap .category-item":"tapFirstCategory","tap .second-category":"tapSecondCategory","change #third-category":"tapThirdCategory","change #hot-sort":"sortBy","tap .btn-search":"redirectToSearch"},redirectToSearch:function(){window.location.hash="search/true"},sortBy:function(E){var D=f(E.currentTarget);var C=0;var A=j.find(".category-item.zmc_act");if(A.html()){C=A.data("id");var B=A.siblings().find(".active");if(B.html()){C=B.data("id")}}if(C>0){r(C,D.val(),function(){})}},addToBasket:function(B){B.stopImmediatePropagation();var A=f(B.currentTarget);c.increase(A.data("id"),1,1,function(C){f.Dialog.info("添加成功");A.siblings().removeClass("eh-hide");A.siblings(".number").text(C.result);flyToCart(B)})},removeToBasket:function(B){B.stopImmediatePropagation();var A=f(B.currentTarget);var C=A.data("id");c.decrease(C,1,1,function(D){c.removeCart(C);if(D.result==0){A.addClass("eh-hide").siblings(".number").addClass("eh-hide");return}A.siblings(".number").text(D.result)})},redirectGoodsDetail:function(B){var A=f(B.currentTarget);if(A.hasClass("counting")){return f.Dialog.info("亲，活动还未开始，请耐心等待")}if(A.children("img").hasClass("empty-mark")){return f.Dialog.info("亲，已售罄了哦！")}window.location.hash="goodsDetail/"+f(B.currentTarget).data("id")},tapFirstCategory:function(B){var A=f(B.currentTarget);if(!A.hasClass("zmc_act")){j.find(".category-item.zmc_act").removeClass("zmc_act").siblings(".panel-collapse").removeClass("in");A.addClass("zmc_act").siblings(".panel-collapse").addClass("in")}if(A.hasClass("btn-history")){s();j.find(".second-category.active").removeClass("active").find("span").remove();j.find("#third-category").empty().append('<option value="">品种</option>')}else{f("#mall-page").find(".second-category").removeClass("active");r(A.data("id"),"","ASC")}},tapSecondCategory:function(E){var D=f(E.currentTarget);if(!D.hasClass("active")){j.find(".second-category.active").removeClass("active").find("span").remove();D.addClass("active").prepend("<span></span>");var F=D.data("id");var C=JSON.parse(localStorage.getItem("third-category-"+F));var A=['<option value="">品种</option>'];for(var B in C){A.push('<option value="'+C[B].id+'">'+C[B].name+"</option>")}j.find("#third-category").empty().append(A.join("\n"));r(F)}a.navigate("mall")},tapThirdCategory:function(B){var A=f(B.currentTarget);var C=A.val();console.info(C);if(C==""||C==null){r(j.find(".second-category.active").data("id"));return}r(C)}});var k=function(){if(y.isEmpty(j.find("#myAccordion"))){f.ajax({url:window.ctx+"mall/goodsCategory",type:"GET",dataType:"json",success:function(B){var A=z.template(l.html());j.find("#myAccordion").empty().append(A(B));n();j.find(".left-panel").height(f(window).height()-50-f(".he-footer").height()+"px")}})}};var n=function(){j.find(".category-item").eq(1).trigger("tap");j.find(".second-category").first().trigger("tap")};var r=function(B,A,C){q=B;f.ajax({url:window.ctx+"mall/goods",type:"GET",data:{category_id:B,sort:A},dataType:"json",success:function(E){var D=z.template(e.html());g.empty().append(D(E));w();typeof C=="function"&&C()}})};var s=function(){f.ajax({url:window.ctx+"mall/hisitories",type:"GET",dataType:"json",success:function(B){var A=z.template(e.html());g.empty().append(A(B));w()}})};var w=function(){setTimeout(function(){x.init({throttle:1000})},360)};var m=function(B){B.stopImmediatePropagation();var A=f(B.currentTarget);var C=A.data("id");c.increase(C,1,1,function(E){A.siblings().removeClass("eh-hide");A.siblings(".number").text(E.result);var D=A.parents(".goods-item").find(".left").attr("src");y.flyToCart(B,D);c.addCart({id:C,quantity:1,type:1})})};return t});