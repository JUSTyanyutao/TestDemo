define(["zepto","underscore","backbone","echo","app/utils","text!templates/balance.html","app/weixin"],function(g,B,d,x,y,n,k){var m;var p;var b;var u;
var h;var z;var j;var a={};var c={latitude:0,longitude:0};var e=d.View.extend({el:g("#balance-page"),render:function(){t(this);y.showHeader({title:"订单结算"});
},events:{"tap .choose-time":"chooseTimeAction","tap .submit":"createOrder","tap .btn-coupon":"chooseCoupon","tap .payment-address":"chooseCabinet","tap .goods-detail":"redirectGoodsDetail"},redirectGoodsDetail:function(D){var C=g(D.currentTarget);
window.location.replace("#orderDetail/"+C.data("id"));},chooseCabinet:function(){window.location.hash="cabinet";},chooseTimeAction:function(){window.location.hash="time";
},chooseCoupon:function(){window.location.hash="balanceCoupon";},createOrder:function(){if(!a.deliveryWayId){return g.Dialog.info("请选择一种派送方式");}if(!a.stationId){return g.Dialog.info("请先选择一个站点");
}if(!a.deliveryDate){return g.Dialog.info("请选择配送时间");}g.ajax({url:window.ctx+"balance/createOrder",type:"POST",dataType:"json",data:{couponId:a.couponId,deliveryWayId:a.deliveryWayId,deliveryDate:a.deliveryDate,deliverySection:a.deliverySection,list:a.list,remark:a.remark,stationId:a.stationId},success:function(D){g.Dialog.info("亲，下单成功啦！");
y.storage.set("balance","{}");y.storage.set("has_goods","0");var C=B.template(u.html());m.empty().append(C(D));}});}});var t=function(C){y.showPage(C.$el,function(){if(y.isEmpty(C.$el)){C.$el.append(n);
m=g("#balance-page");p=m.find("#tpl-goods-list");b=m.find("#tpl-price-info");h=m.find(".price-information");z=m.find("#account-limit");j=m.find("#pay-price");
u=m.find("#success-template");A();s();w();q();k.getLocation(function(D){g.ajax({url:window.ctx+"map/MicroMessageToBaidu",type:"GET",data:{longitude:D.longitude,latitude:D.latitude,},dataType:"json",success:function(E){r(E.longitude,E.latitude);
}});});l();}else{A();w();}});};var w=function(){a=y.storage.get("balance");a=a!=""?JSON.parse(a):{};if(a.deliveryDate&&a.deliverySection){m.find(".choose-time").children("span").text(a.deliveryDate+" "+a.deliverySection);
}if(a.couponId){m.find(".btn-coupon").children("span").text(a.couponName);}if(a.stationName){m.find(".hotel").text(a.stationName);}if(a.stationAddress){m.find(".payment-address").find("p").text(a.stationAddress);
}v();};var r=function(C,D){g.ajax({url:window.ctx+"balance/getCabinets",type:"GET",data:{longitude:C,latitude:D},dataType:"json",success:function(E){if(E.err_code==0&&E.result.list.length>0){y.storage.set("balance_cabinets",JSON.stringify(E));
}else{y.storage.set("balance_cabinets","{}");}}});};var q=function(){g.ajax({url:window.ctx+"coupon/getList",type:"GET",dataType:"json",success:function(C){m.find("#coupon-count").text(C.result.total);
y.storage.set("balance_coupons",JSON.stringify(C));}});};var s=function(){g.ajax({url:window.ctx+"balance/getDeliveryWays",type:"GET",dataType:"json",success:function(D){var C=B.template(m.find("#tpl-delivery").html());
m.find("#container-delivery").empty().append(C(D));if(D.result.list.length==1){o(D.result.list[0].id,D.result.list[0].name,"");}else{i();}}});};var i=function(){m.find(".btn-change-delivery").removeClass("eh-hide").on("tap",function(){m.find(".popbg").height(document.documentElement.clientHeight);
m.find(".getstyle").show();});m.find(".delivery-item").on("tap",function(){o(g(this).data("id"),g(this).data("name"),"");m.find(".popbg").height(0);m.find(".getstyle").hide();
});};var o=function(C,D,E){f({deliveryWayId:C});m.find(".delivery-way-name").text(D);};var A=function(){var E=JSON.parse(y.storage.get("carts"));var D=B.template(p.html());
m.find(".already-buy").empty().append(D(E));g(".albuy-in-wrap").width(g(".albuy-in-wrap").find("img").length*8+"em");var C=[];E.goods.forEach(function(F){C.push(F.id+","+F.quantity);
});f({list:C.join(";")});};var f=function(C){a=y.storage.get("balance");a=a!=null?JSON.parse(a):{};a=g.extend(a,C);y.storage.set("balance",JSON.stringify(a));
};var v=function(){g.ajax({url:window.ctx+"balance/getActualPrice",type:"POST",dataType:"json",data:{couponId:a.couponId,deliveryWayId:a.deliveryWayId,list:a.list},success:function(D){var C=B.template(b.html());
h.empty().append(C(D.result));z.text("¥ "+D.result.balance.toFixed(2));j.text("¥"+D.result.total_money);}});};var l=function(){x.init({throttle:1000});
};return e;});